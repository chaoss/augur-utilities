# Auto-generated docker-compose.yml
version: '3.8'

services:

  redis-cache-1:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance1.env
    restart: always
    networks:
      knot1:
        aliases:
          - redis-cache-1
          - redis-cache

  redis-users-1:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance1.env
    restart: always
    networks:
      knot1:
        aliases:
          - redis-users-1
          - redis-users

  postgres-cache-1:
    image: docker.io/library/postgres:16
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - augur1_db_data:/var/lib/postgresql/data
      - ./postgres/augur1/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./postgres/augur1/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U augur"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      knot1:
        aliases:
          - postgres-cache-1
          - postgres-cache

  db-init-1:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - python3
      - ./cache_manager/db_init.py
    depends_on:
      postgres-cache-1:
        condition: service_healthy
    env_file:
      - envs/instance1.env
    restart: on-failure:1000
    networks:
      knot1:
        aliases:
          - db-init-1
          - db-init

  worker-callback-1:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - --concurrency=1
      - --time-limit=300
      - --soft-time-limit=240
    depends_on:
      - postgres-cache-1
      - redis-cache-1
      - redis-users-1
    env_file:
      - envs/instance1.env
    restart: always
    networks:
      knot1:
        aliases:
          - worker-callback-1
          - worker-callback

  worker-query-1:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - -Q
      - data
      - --concurrency=1
      - --time-limit=600
      - --soft-time-limit=540
    depends_on:
      - postgres-cache-1
      - redis-cache-1
    env_file:
      - envs/instance1.env
    restart: always
    networks:
      knot1:
        aliases:
          - worker-query-1
          - worker-query

  instance1:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - gunicorn
      - --reload
      - --bind
      - :8080
      - app:server
      - --workers
      - "1"
      - --threads
      - "2"
      - --timeout
      - "300"
      - --keep-alive
      - "5"
    ports:
      - "8081:8080"
    env_file:
      - envs/instance1.env
    environment:
      - EIGHTKNOT_SEARCHBAR_OPTS_SORT=shortest
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_RESULTS=5500
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_REPOS=5000
    depends_on:
      worker-callback-1:
        condition: service_started
      worker-query-1:
        condition: service_started
      redis-cache-1:
        condition: service_started
      redis-users-1:
        condition: service_started
      postgres-cache-1:
        condition: service_healthy
      db-init-1:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      knot1:
        aliases:
          - instance1
          - instance

  redis-cache-2:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance2.env
    restart: always
    networks:
      knot2:
        aliases:
          - redis-cache-2
          - redis-cache

  redis-users-2:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance2.env
    restart: always
    networks:
      knot2:
        aliases:
          - redis-users-2
          - redis-users

  postgres-cache-2:
    image: docker.io/library/postgres:16
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - augur2_db_data:/var/lib/postgresql/data
      - ./postgres/augur2/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./postgres/augur2/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U augur"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      knot2:
        aliases:
          - postgres-cache-2
          - postgres-cache

  db-init-2:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - python3
      - ./cache_manager/db_init.py
    depends_on:
      postgres-cache-2:
        condition: service_healthy
    env_file:
      - envs/instance2.env
    restart: on-failure:1000
    networks:
      knot2:
        aliases:
          - db-init-2
          - db-init

  worker-callback-2:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - --concurrency=1
      - --time-limit=300
      - --soft-time-limit=240
    depends_on:
      - postgres-cache-2
      - redis-cache-2
      - redis-users-2
    env_file:
      - envs/instance2.env
    restart: always
    networks:
      knot2:
        aliases:
          - worker-callback-2
          - worker-callback

  worker-query-2:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - -Q
      - data
      - --concurrency=1
      - --time-limit=600
      - --soft-time-limit=540
    depends_on:
      - postgres-cache-2
      - redis-cache-2
    env_file:
      - envs/instance2.env
    restart: always
    networks:
      knot2:
        aliases:
          - worker-query-2
          - worker-query

  instance2:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - gunicorn
      - --reload
      - --bind
      - :8080
      - app:server
      - --workers
      - "1"
      - --threads
      - "2"
      - --timeout
      - "300"
      - --keep-alive
      - "5"
    ports:
      - "8082:8080"
    env_file:
      - envs/instance2.env
    environment:
      - EIGHTKNOT_SEARCHBAR_OPTS_SORT=shortest
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_RESULTS=5500
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_REPOS=5000
    depends_on:
      worker-callback-2:
        condition: service_started
      worker-query-2:
        condition: service_started
      redis-cache-2:
        condition: service_started
      redis-users-2:
        condition: service_started
      postgres-cache-2:
        condition: service_healthy
      db-init-2:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      knot2:
        aliases:
          - instance2
          - instance

  redis-cache-3:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance3.env
    restart: always
    networks:
      knot3:
        aliases:
          - redis-cache-3
          - redis-cache

  redis-users-3:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance3.env
    restart: always
    networks:
      knot3:
        aliases:
          - redis-users-3
          - redis-users

  postgres-cache-3:
    image: docker.io/library/postgres:16
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - augur3_db_data:/var/lib/postgresql/data
      - ./postgres/augur3/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./postgres/augur3/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U augur"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      knot3:
        aliases:
          - postgres-cache-3
          - postgres-cache

  db-init-3:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - python3
      - ./cache_manager/db_init.py
    depends_on:
      postgres-cache-3:
        condition: service_healthy
    env_file:
      - envs/instance3.env
    restart: on-failure:1000
    networks:
      knot3:
        aliases:
          - db-init-3
          - db-init

  worker-callback-3:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - --concurrency=1
      - --time-limit=300
      - --soft-time-limit=240
    depends_on:
      - postgres-cache-3
      - redis-cache-3
      - redis-users-3
    env_file:
      - envs/instance3.env
    restart: always
    networks:
      knot3:
        aliases:
          - worker-callback-3
          - worker-callback

  worker-query-3:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - -Q
      - data
      - --concurrency=1
      - --time-limit=600
      - --soft-time-limit=540
    depends_on:
      - postgres-cache-3
      - redis-cache-3
    env_file:
      - envs/instance3.env
    restart: always
    networks:
      knot3:
        aliases:
          - worker-query-3
          - worker-query

  instance3:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - gunicorn
      - --reload
      - --bind
      - :8080
      - app:server
      - --workers
      - "1"
      - --threads
      - "2"
      - --timeout
      - "300"
      - --keep-alive
      - "5"
    ports:
      - "8083:8080"
    env_file:
      - envs/instance3.env
    environment:
      - EIGHTKNOT_SEARCHBAR_OPTS_SORT=shortest
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_RESULTS=5500
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_REPOS=5000
    depends_on:
      worker-callback-3:
        condition: service_started
      worker-query-3:
        condition: service_started
      redis-cache-3:
        condition: service_started
      redis-users-3:
        condition: service_started
      postgres-cache-3:
        condition: service_healthy
      db-init-3:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      knot3:
        aliases:
          - instance3
          - instance

  redis-cache-4:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance4.env
    restart: always
    networks:
      knot4:
        aliases:
          - redis-cache-4
          - redis-cache

  redis-users-4:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance4.env
    restart: always
    networks:
      knot4:
        aliases:
          - redis-users-4
          - redis-users

  postgres-cache-4:
    image: docker.io/library/postgres:16
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - augur4_db_data:/var/lib/postgresql/data
      - ./postgres/augur4/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./postgres/augur4/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U augur"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      knot4:
        aliases:
          - postgres-cache-4
          - postgres-cache

  db-init-4:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - python3
      - ./cache_manager/db_init.py
    depends_on:
      postgres-cache-4:
        condition: service_healthy
    env_file:
      - envs/instance4.env
    restart: on-failure:1000
    networks:
      knot4:
        aliases:
          - db-init-4
          - db-init

  worker-callback-4:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - --concurrency=1
      - --time-limit=300
      - --soft-time-limit=240
    depends_on:
      - postgres-cache-4
      - redis-cache-4
      - redis-users-4
    env_file:
      - envs/instance4.env
    restart: always
    networks:
      knot4:
        aliases:
          - worker-callback-4
          - worker-callback

  worker-query-4:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - -Q
      - data
      - --concurrency=1
      - --time-limit=600
      - --soft-time-limit=540
    depends_on:
      - postgres-cache-4
      - redis-cache-4
    env_file:
      - envs/instance4.env
    restart: always
    networks:
      knot4:
        aliases:
          - worker-query-4
          - worker-query

  instance4:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - gunicorn
      - --reload
      - --bind
      - :8080
      - app:server
      - --workers
      - "1"
      - --threads
      - "2"
      - --timeout
      - "300"
      - --keep-alive
      - "5"
    ports:
      - "8084:8080"
    env_file:
      - envs/instance4.env
    environment:
      - EIGHTKNOT_SEARCHBAR_OPTS_SORT=shortest
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_RESULTS=5500
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_REPOS=5000
    depends_on:
      worker-callback-4:
        condition: service_started
      worker-query-4:
        condition: service_started
      redis-cache-4:
        condition: service_started
      redis-users-4:
        condition: service_started
      postgres-cache-4:
        condition: service_healthy
      db-init-4:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      knot4:
        aliases:
          - instance4
          - instance

  redis-cache-5:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance5.env
    restart: always
    networks:
      knot5:
        aliases:
          - redis-cache-5
          - redis-cache

  redis-users-5:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance5.env
    restart: always
    networks:
      knot5:
        aliases:
          - redis-users-5
          - redis-users

  postgres-cache-5:
    image: docker.io/library/postgres:16
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - augur5_db_data:/var/lib/postgresql/data
      - ./postgres/augur5/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./postgres/augur5/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U augur"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      knot5:
        aliases:
          - postgres-cache-5
          - postgres-cache

  db-init-5:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - python3
      - ./cache_manager/db_init.py
    depends_on:
      postgres-cache-5:
        condition: service_healthy
    env_file:
      - envs/instance5.env
    restart: on-failure:1000
    networks:
      knot5:
        aliases:
          - db-init-5
          - db-init

  worker-callback-5:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - --concurrency=1
      - --time-limit=300
      - --soft-time-limit=240
    depends_on:
      - postgres-cache-5
      - redis-cache-5
      - redis-users-5
    env_file:
      - envs/instance5.env
    restart: always
    networks:
      knot5:
        aliases:
          - worker-callback-5
          - worker-callback

  worker-query-5:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - -Q
      - data
      - --concurrency=1
      - --time-limit=600
      - --soft-time-limit=540
    depends_on:
      - postgres-cache-5
      - redis-cache-5
    env_file:
      - envs/instance5.env
    restart: always
    networks:
      knot5:
        aliases:
          - worker-query-5
          - worker-query

  instance5:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - gunicorn
      - --reload
      - --bind
      - :8080
      - app:server
      - --workers
      - "1"
      - --threads
      - "2"
      - --timeout
      - "300"
      - --keep-alive
      - "5"
    ports:
      - "8085:8080"
    env_file:
      - envs/instance5.env
    environment:
      - EIGHTKNOT_SEARCHBAR_OPTS_SORT=shortest
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_RESULTS=5500
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_REPOS=5000
    depends_on:
      worker-callback-5:
        condition: service_started
      worker-query-5:
        condition: service_started
      redis-cache-5:
        condition: service_started
      redis-users-5:
        condition: service_started
      postgres-cache-5:
        condition: service_healthy
      db-init-5:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      knot5:
        aliases:
          - instance5
          - instance

  redis-cache-6:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance6.env
    restart: always
    networks:
      knot6:
        aliases:
          - redis-cache-6
          - redis-cache

  redis-users-6:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance6.env
    restart: always
    networks:
      knot6:
        aliases:
          - redis-users-6
          - redis-users

  postgres-cache-6:
    image: docker.io/library/postgres:16
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - augur6_db_data:/var/lib/postgresql/data
      - ./postgres/augur6/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./postgres/augur6/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U augur"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      knot6:
        aliases:
          - postgres-cache-6
          - postgres-cache

  db-init-6:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - python3
      - ./cache_manager/db_init.py
    depends_on:
      postgres-cache-6:
        condition: service_healthy
    env_file:
      - envs/instance6.env
    restart: on-failure:1000
    networks:
      knot6:
        aliases:
          - db-init-6
          - db-init

  worker-callback-6:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - --concurrency=1
      - --time-limit=300
      - --soft-time-limit=240
    depends_on:
      - postgres-cache-6
      - redis-cache-6
      - redis-users-6
    env_file:
      - envs/instance6.env
    restart: always
    networks:
      knot6:
        aliases:
          - worker-callback-6
          - worker-callback

  worker-query-6:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - -Q
      - data
      - --concurrency=1
      - --time-limit=600
      - --soft-time-limit=540
    depends_on:
      - postgres-cache-6
      - redis-cache-6
    env_file:
      - envs/instance6.env
    restart: always
    networks:
      knot6:
        aliases:
          - worker-query-6
          - worker-query

  instance6:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - gunicorn
      - --reload
      - --bind
      - :8080
      - app:server
      - --workers
      - "1"
      - --threads
      - "2"
      - --timeout
      - "300"
      - --keep-alive
      - "5"
    ports:
      - "8086:8080"
    env_file:
      - envs/instance6.env
    environment:
      - EIGHTKNOT_SEARCHBAR_OPTS_SORT=shortest
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_RESULTS=5500
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_REPOS=5000
    depends_on:
      worker-callback-6:
        condition: service_started
      worker-query-6:
        condition: service_started
      redis-cache-6:
        condition: service_started
      redis-users-6:
        condition: service_started
      postgres-cache-6:
        condition: service_healthy
      db-init-6:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      knot6:
        aliases:
          - instance6
          - instance

  redis-cache-7:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance7.env
    restart: always
    networks:
      knot7:
        aliases:
          - redis-cache-7
          - redis-cache

  redis-users-7:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance7.env
    restart: always
    networks:
      knot7:
        aliases:
          - redis-users-7
          - redis-users

  postgres-cache-7:
    image: docker.io/library/postgres:16
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - augur7_db_data:/var/lib/postgresql/data
      - ./postgres/augur7/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./postgres/augur7/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U augur"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      knot7:
        aliases:
          - postgres-cache-7
          - postgres-cache

  db-init-7:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - python3
      - ./cache_manager/db_init.py
    depends_on:
      postgres-cache-7:
        condition: service_healthy
    env_file:
      - envs/instance7.env
    restart: on-failure:1000
    networks:
      knot7:
        aliases:
          - db-init-7
          - db-init

  worker-callback-7:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - --concurrency=1
      - --time-limit=300
      - --soft-time-limit=240
    depends_on:
      - postgres-cache-7
      - redis-cache-7
      - redis-users-7
    env_file:
      - envs/instance7.env
    restart: always
    networks:
      knot7:
        aliases:
          - worker-callback-7
          - worker-callback

  worker-query-7:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - -Q
      - data
      - --concurrency=1
      - --time-limit=600
      - --soft-time-limit=540
    depends_on:
      - postgres-cache-7
      - redis-cache-7
    env_file:
      - envs/instance7.env
    restart: always
    networks:
      knot7:
        aliases:
          - worker-query-7
          - worker-query

  instance7:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - gunicorn
      - --reload
      - --bind
      - :8080
      - app:server
      - --workers
      - "1"
      - --threads
      - "2"
      - --timeout
      - "300"
      - --keep-alive
      - "5"
    ports:
      - "8087:8080"
    env_file:
      - envs/instance7.env
    environment:
      - EIGHTKNOT_SEARCHBAR_OPTS_SORT=shortest
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_RESULTS=5500
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_REPOS=5000
    depends_on:
      worker-callback-7:
        condition: service_started
      worker-query-7:
        condition: service_started
      redis-cache-7:
        condition: service_started
      redis-users-7:
        condition: service_started
      postgres-cache-7:
        condition: service_healthy
      db-init-7:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      knot7:
        aliases:
          - instance7
          - instance

  redis-cache-8:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance8.env
    restart: always
    networks:
      knot8:
        aliases:
          - redis-cache-8
          - redis-cache

  redis-users-8:
    image: docker.io/library/redis:6
    command:
      - /bin/sh
      - -c
      - redis-server --requirepass "$$REDIS_PASSWORD"
    env_file:
      - envs/instance8.env
    restart: always
    networks:
      knot8:
        aliases:
          - redis-users-8
          - redis-users

  postgres-cache-8:
    image: docker.io/library/postgres:16
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - augur8_db_data:/var/lib/postgresql/data
      - ./postgres/augur8/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./postgres/augur8/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U augur"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      knot8:
        aliases:
          - postgres-cache-8
          - postgres-cache

  db-init-8:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - python3
      - ./cache_manager/db_init.py
    depends_on:
      postgres-cache-8:
        condition: service_healthy
    env_file:
      - envs/instance8.env
    restart: on-failure:1000
    networks:
      knot8:
        aliases:
          - db-init-8
          - db-init

  worker-callback-8:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - --concurrency=1
      - --time-limit=300
      - --soft-time-limit=240
    depends_on:
      - postgres-cache-8
      - redis-cache-8
      - redis-users-8
    env_file:
      - envs/instance8.env
    restart: always
    networks:
      knot8:
        aliases:
          - worker-callback-8
          - worker-callback

  worker-query-8:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - celery
      - -A
      - app:celery_app
      - worker
      - --loglevel=INFO
      - -Q
      - data
      - --concurrency=1
      - --time-limit=600
      - --soft-time-limit=540
    depends_on:
      - postgres-cache-8
      - redis-cache-8
    env_file:
      - envs/instance8.env
    restart: always
    networks:
      knot8:
        aliases:
          - worker-query-8
          - worker-query

  instance8:
    build:
      context: /home/sean/github/8knot
      dockerfile: docker/Dockerfile
    command:
      - gunicorn
      - --reload
      - --bind
      - :8080
      - app:server
      - --workers
      - "1"
      - --threads
      - "2"
      - --timeout
      - "300"
      - --keep-alive
      - "5"
    ports:
      - "8088:8080"
    env_file:
      - envs/instance8.env
    environment:
      - EIGHTKNOT_SEARCHBAR_OPTS_SORT=shortest
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_RESULTS=5500
      - EIGHTKNOT_SEARCHBAR_OPTS_MAX_REPOS=5000
    depends_on:
      worker-callback-8:
        condition: service_started
      worker-query-8:
        condition: service_started
      redis-cache-8:
        condition: service_started
      redis-users-8:
        condition: service_started
      postgres-cache-8:
        condition: service_healthy
      db-init-8:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      knot8:
        aliases:
          - instance8
          - instance


volumes:
  augur1_db_data:
  augur2_db_data:
  augur3_db_data:
  augur4_db_data:
  augur5_db_data:
  augur6_db_data:
  augur7_db_data:
  augur8_db_data:

networks:
  knot1:
  knot2:
  knot3:
  knot4:
  knot5:
  knot6:
  knot7:
  knot8:
